<style>
    body {
        font-family: 'Open Sans', sans-serif;
        font-style: italic;
    }
    svg {
        background-image: url("/user/pages/02.d3js/7-scales/grad.jpg");
        padding: 2rem;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    line {
        shape-rendering: geometricPrecision;
    }
    .tick {
        font-size: 12px
    }
    #typeText {
        text-shadow: -3px 0px 0px rgb(131, 132, 100), 44px 44px 11px rgba(0,0,0,0.8);
    }
    .lineLabel {
        font-style: normal;
    }
</style>

<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,800i" rel="stylesheet">

<input type="button" value="Update" onclick="update()" />

<svg id="chart-17" class="chart"></svg>

<script type="text/javascript" src="http://d3js.org/d3.v4.min.js"></script>
<script>

    var margin = {top: 5, right: 80, bottom: 5, left: 0};
    var width  = window.innerWidth - margin.left - (margin.right * 3);
    var height = 500;

    var limit    = 48;
    var exponent = 12;

    var powScale = d3.scalePow()
        .domain([limit + 1, 1 + 1])
        .range([limit, 1])
        .exponent(exponent);

    var logScale = d3.scaleLog()
        .domain([1, limit])
        .range([1, limit])
        .base(31); // ????

    var linear = [];
    for (var i = 1; i <= limit; i++) {
        linear.push({ type: i, sales: i });
    }

    var pow = [];
    for (i = 1; i <= limit; i++) {
        pow.push({ type: i, sales: powScale(i + 1) });
    }

    var log = [];
    for (i = 1; i <= limit; i++) {
        log.push({ type: i,  sales: logScale(i) });
    }

    var x = d3.scaleLinear()
        .domain([1, limit])
        .range([0, width - 100]);

    var y = d3.scaleLinear()
        .domain([1, limit])
        .range([height, 20]);

    var xAxis = d3.axisBottom(x).ticks(20).tickSizeOuter(-height).tickSizeInner(-height );
    var yAxis = d3.axisLeft(y).ticks(20).tickSizeOuter(-width).tickSizeInner(-width + 20);

    var valueline = d3.line().curve(d3.curveCatmullRom)
        .x(function(d) { return x(d.type); })
        .y(function(d) { return y(d.sales); });

    var chart = d3.select('#chart-17')
        .attr('width', width + 1)
        .attr('height', height + margin.top + margin.bottom + 20)
        .attr("fill", "blue")
        .append('g');

    chart.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(80," + height + ")")
        .call(xAxis)
        .append("text")
        .attr("x", width - 150)
        .attr("dy", "-5px")
        .attr("fill", "#000")
        .text("Type");

    chart.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(80, 0)")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("x", -35)
        .attr("dy", "0.71em")
        .attr("fill", "#000")
        .text("Sales");

    chart.append("line")
        .style("stroke", "black")
        .style("stroke-dasharray", "10, 7")
        .style("stroke-opacity", 0.5)
        .attr("x1", margin.left)
        .attr("y1", height + margin.top*3 + 10 )
        .attr("x2", width)
        .attr("y2", 20 - margin.top*2 + 4);

    d3.selectAll(".tick").selectAll("line").attr("opacity", 0.1);

    var types = [
        { type: linear, color: "black", name: "linear" },
        { type: pow,    color: "black", name: "pow"    },
        { type: log,    color: "black", name: "log"    }
    ];

    lines = [];
    lines["linear"] = 0;
    lines["pow"]    = 0;
    lines["log"]    = 0;

    types.forEach(function(entry, i) {

        var type  = entry.type;
        var color = entry.color;
        var name  = entry.name;

        chart.append("path")
            .data(type)
            .attr("id", name)
            .attr("transform", "translate(80, 0)")
            .attr("d", valueline(type))
            .attr("stroke", color)
            .attr("stroke-width", 2)
            .attr("fill", "none");

        chart.append("text")
            .attr("transform", "translate(0, 24)")
            .style("font-size", "20px")
            .append("textPath")
            .attr("class", "lineLabel")
            .attr("transform", "translate(80, 60)")
            .attr("startOffset","90" - ((i+1)*10) + "%")
            .attr("xlink:href", "#" + name)
            .text(name);

        if (limit < 100) {
            chart.selectAll("." + name)
                .data(type).enter()
                .append("circle")
                .attr("class", name)
                .attr("transform", "translate(80, 0)")
                .attr("r", "2")
                .attr("stroke", color)
                .attr("stroke-width", 3)
                .attr("fill", color)
                .attr("cx", function (d) { return x(d.type) })
                .attr("cy", function (d) { return y(d.sales) })
                .on("mouseover", function(d) {
                    posXText.attr("y", y(d.sales) - 5).text(d.sales);
                    posYText.attr("x", x(d.type) + margin.right + 5).text(d.type);

                    chart.append("line")
                        .transition().duration(750)
                        .attr("id", "helpLineY")
                        .style("stroke", "black")
                        .style("stroke-dasharray", "10, 7")
                        .style("stroke-opacity", 0.5)
                        .attr("stroke-width", 1)
                        .attr("x1", x(d.type) + margin.right)
                        .attr("y1", y(d.sales))
                        .attr("x2", 80)
                        .attr("y2", y(d.sales));

                    chart.append("line")
                        .attr("id", "helpLineX")
                        .style("stroke", "black")
                        .style("stroke-dasharray", "10, 7")
                        .style("stroke-opacity", 0.5)
                        .attr("stroke-width", 1)
                        .attr("x1", x(d.type) + margin.right)
                        .attr("y1", y(d.sales))
                        .attr("x2", x(d.type) + margin.right)
                        .attr("y2", height);

                })
                .on("click", function(d) {
                    var currentLine = this.className.baseVal;

                    if (lines[currentLine] === 0) {
                        d3.transition()
                            .select("#" + currentLine)
                            .duration(750)
                            .attr("stroke", "steelblue");
                        d3.transition()
                            .selectAll("." + currentLine)
                            .duration(750)
                            .attr("r", 5)
                            .attr("fill", "steelblue")
                            .attr("stroke-width", 1)
                            .style("stroke", "black");
                        lines[currentLine] = 1;
                    } else {
                        d3.transition()
                            .select("#" + currentLine)
                            .duration(750)
                            .attr("stroke", color);
                        d3.transition()
                            .selectAll("." + currentLine)
                            .duration(750)
                            .attr("r", 2)
                            .attr("fill", color)
                            .attr("stroke-width", 2)
                            .style("stroke", "black");
                        lines[currentLine] = 0;
                    }
                })
                .on("mouseout", function() {
                    posXText.text("");
                    posYText.text("");
                    d3.select("#helpLineY").remove();
                    d3.select("#helpLineX").remove();
                });
        }
    });

    var typer = chart.append("text")
        .text("Linear")
        .attr("id", "typeText")
        .attr("font-size", 50)
        .attr("x", 200)
        .attr("y", 100);

    var posText = chart.append("text")
        .attr("font-size", 20)
        .attr("x", 200)
        .attr("y", 140);

    var posXText = posText.append("tspan").attr("dy", 0);
    var posYText = posText.append("tspan").attr("dy", 80);

    var current = 0;
    var type    = "";

    function update() {
        if (current === 0) {
            type = "Pow";
            y = d3.scalePow()
                .domain([1, limit])
                .range([height, 20])
                .exponent(exponent);
            current = 1;
        } else if(current === 1)  {
            type = "Log";
            y = d3.scaleLog()
                .domain([1, limit])
                .range([height, 20])
                .base(3);
            current = 2;
        } else if(current === 2)  {
            type = "Linear";
            x = d3.scaleLinear()
                .domain([1, limit])
                .range([0, width - 100]);
            y = d3.scaleLinear()
                .domain([1, limit])
                .range([height, 20]);
            current = 0;
        }
        typer.text(type);

        var chart = d3.select("#chart-17");

        yAxis = d3.axisLeft(y).ticks(20).tickSizeOuter(-width).tickSizeInner(-width + 20);

        chart.transition().select(".y.axis")
            .duration(750)
            .call(yAxis);
        chart.transition().select(".x.axis")
            .duration(750)
            .call(xAxis);

        d3.selectAll(".tick").selectAll("line").attr("opacity", 0.1);

        types.forEach(function(entry) {

            chart.select("#" + entry.name)
                .transition()
                .duration(750)
                .attr("d", valueline(entry.type));
            chart.selectAll("." + entry.name)
                .transition()
                .duration(750)
                .attr("cy", function(d) { return y(d.sales) });
        });
    }
</script>